<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>訪問看護報告書 Renamer</title>
  <!-- SEO Meta Tags -->
  <meta name="description" content="AI (Gemini) または正規表現でPDFを解析し、最適なファイル名を自動生成するツールです。">
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap');

    :root {
      --primary: #1e40af;
      --primary-hover: #1e3a8a;
    }

    body {
      font-family: 'Inter', 'Roboto', 'Outfit', sans-serif;
      background-color: #f8fafc;
    }

    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script>
    const { useState, useEffect, useRef, createElement: h } = React;

    // Icon component wrapper
    const Icon = ({ name, ...props }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && window.lucide) {
          const iconName = name.charAt(0).toLowerCase() + name.slice(1).replace(/([A-Z])/g, '-$1').toLowerCase();
          lucide.createIcons({ icons: { [iconName]: lucide[name] }, nameAttr: 'data-lucide' });
        }
      }, [name]);
      return h('i', { ref, 'data-lucide': name, ...props });
    };

    const App = () => {
      const [files, setFiles] = useState([]);
      const [isProcessing, setIsProcessing] = useState(false);
      const [dragActive, setDragActive] = useState(false);
      const [pdfLibLoaded, setPdfLibLoaded] = useState(false);

      // Settings for LLM
      const [showSettings, setShowSettings] = useState(false);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
      const [modelName, setModelName] = useState('gemini-3-flash-preview');

      // Copy status
      const [copyStatus, setCopyStatus] = useState('');

      // Constants
      const FIXED_DOCTOR = "大西康則";
      const FIXED_MANAGER = "おおぞら";

      // Save API key
      useEffect(() => {
        localStorage.setItem('gemini_api_key', apiKey);
      }, [apiKey]);

      // Load PDF.js dynamically
      useEffect(() => {
        const script = document.createElement('script');
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
        script.async = true;
        script.onload = () => {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
          setPdfLibLoaded(true);
        };
        document.head.appendChild(script);
      }, []);

      // --- Extraction Logic ---
      const parseDateToYYYYMMDD_Regex = (text) => {
        const datePatterns = [
          /令和(\d+|元)年(\d{1,2})月(\d{1,2})日/g,
          /20(\d{2})年(\d{1,2})月(\d{1,2})日/g,
          /20(\d{2})\/(\d{1,2})\/(\d{1,2})/g,
          /20(\d{2})\.(\d{1,2})\.(\d{1,2})/g
        ];

        let foundDates = [];
        datePatterns.forEach(pattern => {
          let match;
          while ((match = pattern.exec(text)) !== null) {
            let year, month, day;
            if (match[0].includes("令和")) {
              const reiwaYear = match[1] === "元" ? 1 : parseInt(match[1]);
              year = 2018 + reiwaYear;
            } else if (match[1].length === 2) {
              year = 2000 + parseInt(match[1]);
            } else {
              year = parseInt(match[1]);
            }
            month = parseInt(match[2]);
            day = parseInt(match[3]);
            if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
              foundDates.push(new Date(year, month - 1, day));
            }
          }
        });
        if (foundDates.length === 0) return "";
        foundDates.sort((a, b) => b - a);
        const newest = foundDates[0];
        const y = newest.getFullYear();
        const m = String(newest.getMonth() + 1).padStart(2, '0');
        const d = String(newest.getDate()).padStart(2, '0');
        return `${y}${m}${d}`;
      };

      const extractNames_Regex = (text) => {
        const cleanText = text.replace(/\s+/g, "");
        let user = "", doctor = "", manager = "";

        const userMatch = cleanText.match(/(氏名|利用者名)[::]?([^\d::年月日]+?)(様|殿|男|女|生年月日|$)/);
        if (userMatch && userMatch[2]) user = userMatch[2].replace(/[ 　]/g, "");

        const doctorMatch = cleanText.match(/(主治医|報告先|医師)[::]?([^\d::年月日]+?)(先生|様|殿|$)/);
        if (doctorMatch && doctorMatch[2]) doctor = doctorMatch[2].replace(/[ 　]/g, "");

        const managerMatch = cleanText.match(/(管理者|作成者)[::]?([^\d::年月日]+?)(印|$)/);
        if (managerMatch && managerMatch[2]) manager = managerMatch[2].replace(/[ 　]/g, "");

        return { user, doctor, manager };
      };

      const analyzeWithGemini = async (base64Image) => {
        if (!apiKey) return null;
        const prompt = `
              この画像は精神科訪問看護報告書です。
              画像から以下の情報を抽出し、JSON形式のみで出力してください。
              
              抽出ルール:
              1. date: 本文中の最も新しい日付（作成日や報告日）を探し、YYYYMMDD形式に変換する。
              2. user: 利用者氏名（様、殿などの前にある名前）。
              3. doctor: 報告先の医師名。もし「大西」や「大西康則」に関連する記述があれば「大西康則」とする。
              4. manager: 事業所の管理者名。もし不明な場合や特定の事業所（おおぞら）に関連する文書であれば「おおぞら」とする。

              出力例: {"date": "20240101", "user": "山田太郎", "doctor": "大西康則", "manager": "おおぞら"}
            `;

        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { text: prompt },
                  {
                    inline_data: {
                      mime_type: "image/jpeg",
                      data: base64Image
                    }
                  }
                ]
              }]
            })
          });
          const data = await response.json();
          let resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
          resultText = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
          return JSON.parse(resultText);
        } catch (error) {
          console.error("Gemini Error:", error);
          return null;
        }
      };

      const processFile = async (file) => {
        if (!window.pdfjsLib) return null;
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;

          // 1ページ目を取得
          const page = await pdf.getPage(1);
          const viewport = page.getViewport({ scale: 2.0 }); // 2倍でレンダリング（OCR精度向上のため）

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          await page.render({ canvasContext: context, viewport: viewport }).promise;

          // 画像データ（Base64）に変換
          const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

          // 正規表現用のテキスト抽出も並行して行う（フォールバック用）
          let fullText = "";
          for (let i = 1; i <= pdf.numPages; i++) {
            const p = await pdf.getPage(i);
            const textContent = await p.getTextContent();
            fullText += textContent.items.map(item => item.str).join(" ") + "\n";
          }

          let resDate, resUser, resDoctor, resManager, usedAI = false;
          if (apiKey) {
            const aiResult = await analyzeWithGemini(imageData);
            if (aiResult) {
              resDate = aiResult.date || "";
              resUser = aiResult.user || "";
              resDoctor = aiResult.doctor || "";
              resManager = aiResult.manager || "";

              // 補正ロジック
              if (resDoctor.includes("大西")) resDoctor = FIXED_DOCTOR;
              if (!resManager || resManager === "管理者不明") resManager = FIXED_MANAGER;

              usedAI = true;
            }
          }
          if (!usedAI) {
            resDate = parseDateToYYYYMMDD_Regex(fullText);
            const names = extractNames_Regex(fullText);
            resUser = names.user; resDoctor = names.doctor; resManager = names.manager;
          }

          return {
            id: Math.random().toString(36).substr(2, 9),
            originalName: file.name,
            date: resDate || "DATE_NOT_FOUND",
            user: resUser || "氏名不明",
            doctor: resDoctor || "医師不明",
            manager: resManager || "管理者不明",
            isHandwritten: false,
            rawTextLength: fullText.length,
            usedAI: usedAI
          };
        } catch (error) {
          console.error("Process error:", error);
          return { id: Math.random().toString(36).substr(2, 9), originalName: file.name, error: true };
        }
      };

      const handleFiles = async (newFiles) => {
        if (!pdfLibLoaded) return;
        setIsProcessing(true);
        const validFiles = Array.from(newFiles).filter(f => f.type === "application/pdf");
        for (const file of validFiles) {
          const result = await processFile(file);
          if (result) setFiles(prev => [...prev, result]);
          if (apiKey) await new Promise(r => setTimeout(r, 600));
        }
        setIsProcessing(false);
      };

      const updateFile = (id, field, value) => {
        setFiles(files.map(f => f.id === id ? { ...f, [field]: value } : f));
      };

      const toggleHandwritten = (id) => {
        setFiles(files.map(f => {
          if (f.id === id) {
            const newState = !f.isHandwritten;
            return {
              ...f, isHandwritten: newState,
              doctor: newState ? FIXED_DOCTOR : f.doctor,
              manager: newState ? FIXED_MANAGER : f.manager
            };
          }
          return f;
        }));
      };

      const handleCopyToClipboard = () => {
        const header = "元のファイル名\t作成されたファイル名";
        const rows = files.map(f => {
          const newName = `${f.date}_${f.user}_${f.doctor}_${f.manager}`.replace(/\s+/g, '');
          return `${f.originalName}\t${newName}`;
        }).join("\n");
        navigator.clipboard.writeText(`${header}\n${rows}`).then(() => {
          setCopyStatus('copied');
          setTimeout(() => setCopyStatus(''), 2000);
        });
      };

      return h('div', { className: "min-h-screen p-4 md:p-8" },
        h('div', { className: "max-w-6xl mx-auto space-y-6" },

          // Header
          h('header', { className: "glass p-6 rounded-2xl shadow-xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4" },
            h('div', null,
              h('h1', { className: "text-3xl font-black text-blue-900 flex items-center gap-3" },
                h(Icon, { name: 'FileText', className: "w-10 h-10 text-blue-600" }),
                "Renamer Pro"
              ),
              h('p', { className: "text-slate-500 font-medium mt-1" }, "訪問看護報告書のファイル名自動生成ツール"),
              h('p', { className: "text-xs text-slate-400 mt-1" }, `AIモデル: ${modelName}`)
            ),
            h('div', { className: "flex gap-2" },
              h('button', {
                onClick: () => setShowSettings(!showSettings),
                className: `px-4 py-2 rounded-xl transition-all border flex items-center gap-2 font-bold ${showSettings ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`
              },
                h(Icon, { name: 'Settings', className: "w-5 h-5" }),
                h('span', { className: "hidden sm:inline" }, "設定")
              ),
              h('button', {
                onClick: () => {
                  setFiles([]);
                  const fileInput = document.getElementById('file-upload');
                  if (fileInput) fileInput.value = '';
                },
                className: "px-4 py-2 bg-white text-slate-600 hover:text-red-500 rounded-xl transition-all border hover:bg-red-50 flex items-center gap-2 font-bold",
                title: "リセット"
              },
                h(Icon, { name: 'Trash2', className: "w-5 h-5" }),
                h('span', { className: "hidden sm:inline" }, "リセット")
              ),
              h('button', {
                onClick: handleCopyToClipboard,
                disabled: files.length === 0,
                className: `px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-all ${files.length > 0 ? 'bg-emerald-600 text-white hover:bg-emerald-700 hover:scale-105 active:scale-95' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`
              },
                copyStatus === 'copied' ? h(Icon, { name: 'Check', className: "w-5 h-5" }) : h(Icon, { name: 'Copy', className: "w-5 h-5" }),
                copyStatus === 'copied' ? 'コピー完了' : '表データをコピー'
              )
            )
          ),

          // Settings
          showSettings && h('div', { className: "glass p-6 rounded-2xl shadow-inner border-2 border-blue-100 animate-in slide-in-from-top-4 duration-300" },
            h('div', { className: "flex items-center gap-2 mb-4 text-blue-900 font-bold" },
              h(Icon, { name: 'Key', className: "w-5 h-5" }),
              " Gemini API設定"
            ),
            h('div', { className: "grid md:grid-cols-2 gap-4" },
              h('input', {
                type: "password",
                value: apiKey,
                onChange: (e) => setApiKey(e.target.value),
                placeholder: "APIキー (AIza...)",
                className: "p-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 outline-none w-full transition-all"
              }),
              h('input', {
                type: "text",
                value: modelName,
                onChange: (e) => setModelName(e.target.value),
                placeholder: "モデル名",
                className: "p-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 outline-none w-full transition-all"
              })
            ),
            h('p', { className: "text-xs text-slate-400 mt-2" }, "※APIキーを入力すると、より正確な解析が可能になります。")
          ),

          // Upload Section
          h('div', {
            onDragOver: (e) => { e.preventDefault(); setDragActive(true) },
            onDragLeave: () => setDragActive(false),
            onDrop: (e) => { e.preventDefault(); setDragActive(false); handleFiles(e.dataTransfer.files) },
            onClick: () => document.getElementById('file-upload').click(),
            className: `relative border-4 border-dashed rounded-3xl p-12 text-center transition-all cursor-pointer group ${dragActive ? 'border-blue-500 bg-blue-50/50 scale-[1.02]' : 'border-slate-300 bg-white hover:border-blue-400 hover:bg-slate-50/50'}`
          },
            h('input', { type: "file", id: "file-upload", multiple: true, accept: ".pdf", className: "hidden", onChange: (e) => handleFiles(e.target.files) }),
            h('div', { className: "flex flex-col items-center gap-4" },
              h('div', { className: `p-6 rounded-full transition-colors ${dragActive ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-400 group-hover:bg-blue-50 group-hover:text-blue-400'}` },
                h(Icon, { name: 'Upload', className: "w-12 h-12" })
              ),
              h('div', null,
                h('p', { className: "text-xl font-bold text-slate-700" }, "PDFファイルをここにドロップ"),
                h('p', { className: "text-slate-400 mt-1" }, "またはクリックして選択")
              )
            ),
            isProcessing && h('div', { className: "absolute inset-0 bg-white/60 backdrop-blur-md rounded-3xl flex items-center justify-center z-10" },
              h('div', { className: "flex flex-col items-center gap-3" },
                h(Icon, { name: 'RefreshCw', className: "w-12 h-12 text-blue-600 animate-spin" }),
                h('span', { className: "font-bold text-blue-900" }, "解析中...")
              )
            )
          ),

          // Results Table
          files.length > 0 && (() => {
            const fileNameCounts = files.reduce((acc, f) => {
              const name = `${f.date}_${f.user}_${f.doctor}_${f.manager}`.replace(/\s+/g, '');
              acc[name] = (acc[name] || 0) + 1;
              return acc;
            }, {});

            return h('div', { className: "glass rounded-3xl shadow-2xl border border-white overflow-hidden" },
              h('div', { className: "overflow-x-auto" },
                h('table', { className: "w-full text-left" },
                  h('thead', { className: "bg-slate-900/5 text-slate-600 uppercase text-xs font-bold" },
                    h('tr', null,
                      h('th', { className: "p-5" }, "元のファイル名"),
                      h('th', { className: "p-5" }, "手書き"),
                      h('th', { className: "p-5 whitespace-nowrap" }, "日付 (YYYYMMDD)"),
                      h('th', { className: "p-5" }, "利用者名"),
                      h('th', { className: "p-5" }, "医師 / 管理者"),
                      h('th', { className: "p-5" }, "出力名プレビュー"),
                      h('th', { className: "p-5" }, "")
                    )
                  ),
                  h('tbody', { className: "divide-y divide-slate-100" },
                    files.map(f => {
                      const outputName = `${f.date}_${f.user}_${f.doctor}_${f.manager}`.replace(/\s+/g, '');
                      const isDuplicate = fileNameCounts[outputName] > 1;

                      return h('tr', { key: f.id, className: `hover:bg-blue-50/30 transition-colors ${isDuplicate ? 'bg-red-50/50' : ''}` },
                        h('td', { className: "p-5" },
                          h('div', { className: "font-bold text-slate-700 flex items-center gap-2" },
                            h(Icon, { name: 'FileText', className: "w-4 h-4 text-blue-400" }),
                            f.originalName
                          ),
                          f.usedAI && h('span', { className: "text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold" }, "AI解析")
                        ),
                        h('td', { className: "p-5" },
                          h('button', {
                            onClick: () => toggleHandwritten(f.id),
                            className: `w-12 h-6 rounded-full transition-all relative ${f.isHandwritten ? 'bg-blue-600' : 'bg-slate-200'}`
                          },
                            h('div', { className: `absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${f.isHandwritten ? 'left-7' : 'left-1'}` })
                          )
                        ),
                        h('td', { className: "p-5" },
                          h('input', { value: f.date, onChange: (e) => updateFile(f.id, 'date', e.target.value), className: "w-28 p-2 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none transition-all" })
                        ),
                        h('td', { className: "p-5" },
                          h('input', { value: f.user, onChange: (e) => updateFile(f.id, 'user', e.target.value), className: "w-full p-2 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none transition-all" })
                        ),
                        h('td', { className: "p-5 space-y-2" },
                          h('input', { value: f.doctor, disabled: f.isHandwritten, onChange: (e) => updateFile(f.id, 'doctor', e.target.value), className: `w-full p-2 rounded-lg border outline-none ${f.isHandwritten ? 'bg-slate-50 text-slate-400 border-slate-100' : 'focus:ring-2 focus:ring-blue-500'}` }),
                          h('input', { value: f.manager, disabled: f.isHandwritten, onChange: (e) => updateFile(f.id, 'manager', e.target.value), className: `w-full p-2 rounded-lg border outline-none ${f.isHandwritten ? 'bg-slate-50 text-slate-400 border-slate-100' : 'focus:ring-2 focus:ring-blue-500'}` })
                        ),
                        h('td', { className: "p-5" },
                          h('div', { className: "flex flex-col gap-1" },
                            h('code', { className: `text-xs p-2 rounded-lg block break-all font-bold ${isDuplicate ? 'bg-red-100 text-red-700 ring-2 ring-red-500' : 'bg-slate-100 text-slate-600'}` },
                              outputName
                            ),
                            isDuplicate && h('span', { className: "text-[10px] text-red-600 font-bold flex items-center gap-1" },
                              h(Icon, { name: 'AlertCircle', className: "w-3 h-3" }),
                              "ファイル名が重複しています"
                            )
                          )
                        ),
                        h('td', { className: "p-5" },
                          h('button', { onClick: () => setFiles(files.filter(x => x.id !== f.id)), className: "text-slate-300 hover:text-red-500" },
                            h(Icon, { name: 'Trash2', className: "w-5 h-5" })
                          )
                        )
                      );
                    })
                  )
                )
              )
            );
          })()
        )
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>

</html>